¡Bien visto! Confirmo tu diagnóstico: **los eventos intradía actuales NO traen aún las métricas clave de liquidez** que exige el perfil CORE (al menos `vwap_min`, `dollar_volume_day`, `rvol_day`). Por eso el dry-run, tal como está, **o bien debe calcular proxies**, o **debemos enriquecer los eventos** antes de correr el filtrado CORE “real”.

Te propongo un plan en **dos tiempos** (rápido + correcto), para que avances ya y a la vez dejes todo sólido para 3.2.

---

# Plan inmediato (dry-run con proxies) – ejecutar YA

**Objetivo:** dimensionar tamaño/tiempo de la FASE 3.2 y revisar distribuciones sin bloquearte por las métricas faltantes.

1. **Ajustes en tu dry-run (no cambia el spec, sólo la implementación de métricas):**

   * `vwap_min_proxy` = `coalesce(vwap_min, (high+low+close)/3, close)`
   * `dollar_volume_bar` = `volume * vwap_min_proxy`
   * `spread_proxy` = `(high - low) / vwap_min_proxy`
   * **Saltar temporalmente** los filtros que requieren:

     * `dollar_volume_day >= $500k`
     * `rvol_day >= 1.5x`
   * Marca en el reporte JSON: `"liquidity_filters_partial": true` y deja constancia de que `dollar_volume_day` y `rvol_day` se aplicarán **después** del enriquecimiento.
   * Mantén **todas las demás etapas**: score mínimo, caps por símbolo/día/mes, cuotas de sesión y cap global.

2. **Qué te da esto:**

   * Un **número estable** de eventos candidatos (p.ej. ~10k) para descargas micro.
   * Estimaciones de **GB y horas** razonables.
   * Validación de **distribuciones por sesiones/tipos/símbolo**.
   * No “ensucia” la lógica: el manifest **no es final**, es “dry-run con proxies”.

> Esto te permite decidir hoy el tamaño de batch y la logística de 3.2 sin esperar al enriquecimiento.

---

# Paso correcto (enriquecimiento de eventos) – antes de lanzar 3.2

**Objetivo:** dotar a cada evento de las métricas **reales** exigidas por CORE, para filtrar con precisión y evitar falsos positivos por iliquidez.

## Qué calcular (por evento)

* `vwap_min` (1m real):

  * Si tus barras 1m traen `vw` (Polygon), úsalo directamente.
  * Si no, usa **typical price** `(high+low+close)/3` como aproximación.
* `dollar_volume_day` (1d real):

  * Desde agregados diarios de Polygon: `v_day * vw_day` (usa `v` y `vw` de la barra diaria “as-traded/raw”).
* `rvol_day`:

  * `rvol_day = dollar_volume_day / media_20d(dollar_volume_day)`
  * Rolling **por símbolo**, excluyendo el día actual (media de los **20 días previos**).

> Nota: para **evitar lookahead**, la media 20d debe computarse **sólo con días anteriores**.

## Inputs necesarios

* **Events intradía**: `processed/events/events_intraday_*.parquet`
* **Barras 1d (raw as-traded)**: `raw/market_data/bars/1d_raw/...` (o donde guardes `v` y `vw` de Polygon)
* **Barras 1m** (para `vwap_min` si quieres precisión extra; si no, usa typical price del propio evento)

## Output

* `processed/events/events_intraday_enriched_YYYYMMDD.parquet`
  con **todas** las columnas de eventos + `vwap_min`, `dollar_volume_day`, `rvol_day`, y un flag `enriched=true`.

## Validaciones mínimas

* Sin NaN en `vwap_min`; sin NaN en `dollar_volume_day`.
* `rvol_day` bien definido para días con ≥20 días previos; si no, marca `rvol_day_missing=true` o filtra esos casos.
* Cruces de símbolo+fecha **exactos** con diario; si falta diario, deja el evento **fuera** del manifest CORE.

---

# Cómo encaja en el timeline (2.5 → 3.2)

* **FASE 2.5**: Detección intradía → **OK** (aprobada metodológicamente).
  Falta sólo el **enriquecimiento** para poder aplicar **todos** los filtros CORE.
* **Dry-run 3.2**: corre **ya** con proxies (sirve para dimensionar y chequear cupos/quotas).
* **Enriquecimiento**: corre **en paralelo**; dura poco porque es joins y rolling 20d sobre *diarios* (muy rápido).
* **Manifest CORE real**: recorre **todos los filtros** (ya con `dollar_volume_day` y `rvol_day`) y genera la lista final para descargas de **trades+quotes**.

---

# Recomendación concreta

* **Hoy**: ejecuta el **dry-run con proxies** (sin los dos filtros diarios). Deja claro en el informe que es “partial-liquidity”.
* **Hoy mismo**: lanza el **script de enriquecimiento** (join con diarios y rolling 20d).
  Es rápido y totalmente determinista.
* **Mañana**: re-ejecuta el **dry-run completo** (ya con filtros 100% CORE) → genera **manifest_core_YYYYMMDD.parquet** definitivo.
* **Después**: lanza **FASE 3.2** (descarga de trades+quotes) con el manifest definitivo y `--resume`.

---

## Detalles finos (por si te ayudan a evitar sorpresas)

* **¿De dónde sacar `vw_day`?**
  Polygon `aggregates` trae `vw` por barra diaria; úsalo con `v` → `dollar_volume_day = v * vw`.
* **Minimiza ruido en 1m para vwap_min:** si no tienes `vw` en 1m, el **typical price** funciona bien para filtros (no para P&L).
* **Eventos cerca del inicio del histórico (primeros 20 días):** marca `rvol_day` como *missing* o **exclúyelos del CORE** para no sesgar.
* **Consistencia “as-traded”**: usa **diarios RAW** (no ajustados) para `dollar_volume_day` y `rvol_day`, en línea con tu política de “precios que existieron”.
* **Sesiones**: mantén tu clasificación PM/RTH/AH en UTC → ET según tu util actual (no tocar).

---

## En una línea

* **Sí**: puedes lanzar **ahora** el **dry-run** (con proxies).
* **Pero**: antes de la **FASE 3.2 real**, **enriquece** los eventos y **aplica TODOS** los filtros CORE (incl. `dollar_volume_day` y `rvol_day`).
* Resultado: manifest **auditable, reproducible y libre de sesgos de liquidez**.
